<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ê²Œì‹œê¸€ ìƒì„¸ ë³´ê¸°</title>

  <!-- âœ… Tmap ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=L5YgKBB01c4hpq2CIQupG4yaczLAmZBaaohHMfD0"></script>

  <!-- âœ… Kakao ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜ìš© ìŠ¤í¬ë¦½íŠ¸ (ì§€ì˜¤ì½”ë”©ìš©) -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5785ff36be13888f3f627611b39b95d7&libraries=services"></script>

  <style>
    #map {
      width: 100%;
      height: 400px;
      margin-top: 20px;
    }
    .btn-group {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }
  </style>
</head>
<body>
<div class="container mt-5 p-4 bg-white shadow rounded" style="max-width: 800px;">
  <h1 class="mb-4 fw-bold">ê²Œì‹œê¸€ ìƒì„¸</h1>

  <!-- ê²Œì‹œê¸€ ì •ë³´ -->
  <p><strong>ì¶œë°œì§€:</strong> <span th:text="${post.departure}"></span></p>
  <p><strong>ë„ì°©ì§€:</strong> <span th:text="${post.destination}"></span></p>
  <p><strong>ì¶œë°œ ì‹œê°:</strong> <span th:text="${post.departureTime}"></span></p>
  <p><strong>ì˜ˆìƒ ìš”ê¸ˆ:</strong> <span id="fare"></span>ì›</p>
  <p><strong>ì˜ˆìƒ ì†Œìš” ì‹œê°„:</strong> <span id="time"></span></p>
  <div class="mb-3">
    <form id="participateForm" th:action="@{/api/taxi-posts/join}" method="post"
          th:object="${post}"
          onsubmit="return confirm('ì°¸ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
      <input type="hidden" name="postId" th:value="${post.id}" />
      <button type="submit" class="btn btn-success btn-sm">ğŸš– ì°¸ì—¬í•˜ê¸°</button>
    </form>
  </div>

  <!-- âœ… ì‘ì„±ì ë³¸ì¸ì¼ ë•Œë§Œ â€œì‚­ì œâ€ì™€ â€œìˆ˜ì •â€ ë²„íŠ¼ ë…¸ì¶œ -->
  <div class="btn-group" th:if="${isOwner}">
    <!-- ì‚­ì œ ë²„íŠ¼ -->
    <form th:action="@{'/api/taxi-posts/' + ${post.id} + '/delete'}" method="post" th:object="${post}"
          onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
      <button type="submit" class="btn btn-danger btn-sm">ì‚­ì œí•˜ê¸°</button>
    </form>
    <!-- ìˆ˜ì • ë²„íŠ¼ (ì›í•˜ë©´ ê²½ë¡œ/ì»¨íŠ¸ë¡¤ëŸ¬ êµ¬í˜„) -->

    <button type="button" class="btn btn-danger btn-sm"
            th:onclick="|handleEdit([[${post.id}]])|">ìˆ˜ì •í•˜ê¸°</button>


  </div>

  <!-- ì§€ë„ + ëŒ“ê¸€ ì˜ì—­ì„ ë‚˜ë€íˆ ë°°ì¹˜ -->
  <div class="row my-4">
    <!-- ì§€ë„ ì˜ì—­ -->
    <div class="col-md-7">
      <div id="map" style="height: 400px; border-radius: 10px; overflow: hidden;"></div>
    </div>

    <div>
      <button onclick="toggleParticipants()" class="btn btn-outline-secondary btn-sm mb-2">ğŸ‘¥ ì°¸ì—¬ì ëª…ë‹¨ ë³´ê¸°</button>
      <ul id="participantList" style="display:none;">
        <li th:each="member : ${participants}">
          <span th:text="${member.id}">ì°¸ì—¬ìID</span>
        </li>
      </ul>
    </div>
    <!-- ëŒ“ê¸€ ì˜ì—­ -->
    <div class="col-md-5">
      <h5 class="mb-3">ëŒ“ê¸€</h5>

      <!-- ëŒ“ê¸€ ëª©ë¡ -->
      <div id="comments">
        <div class="mb-3 border-bottom pb-2" th:each="comment : ${post.comments}">
          <strong th:text="${comment.author.id}">ì‘ì„±ì</strong>
          <p th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©</p>
          <small th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼ì‹œ</small>
        </div>
      </div>

      <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
      <form th:action="@{/api/taxi-posts/api/comments}" method="post">
        <input type="hidden" name="postId" th:value="${post.id}" />
        <div class="mb-2">
          <textarea class="form-control" name="content" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
        </div>
        <button type="submit" class="btn btn-sm btn-primary">ëŒ“ê¸€ ë‹¬ê¸°</button>
      </form>
    </div>
  </div>

  <!-- ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
  <div class="text-center">
    <a href="/api/taxi-posts/postList" class="btn btn-outline-primary px-4 py-2 rounded-pill">
      â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    </a>
  </div>
</div>


<script th:inline="javascript">
  const startLat = /*[[${post.departureLat}]]*/ 37.5665;
  const startLon = /*[[${post.departureLon}]]*/ 126.9780;

  // ë„ì°©ì§€ ìœ„/ê²½ë„ (DBì— ì €ì¥ëœ ê°’ ì‚¬ìš©)
  const endLat = /*[[${post.destinationLat}]]*/ 35.11469;
  const endLon = /*[[${post.destinationLon}]]*/ 128.9665;

  const tmapKey = 'L5YgKBB01c4hpq2CIQupG4yaczLAmZBaaohHMfD0';

  const map = new Tmapv2.Map("map", {
    center: new Tmapv2.LatLng(startLat, startLon),
    width: "100%",
    height: "400px",
    zoom: 15
  });

  getTmapRoute(startLon, startLat, endLon, endLat);

  function getTmapRoute(startX, startY, endX, endY) {
    fetch("https://apis.openapi.sk.com/tmap/routes?version=1", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "appKey": tmapKey
      },
      body: JSON.stringify({
        startX, startY, endX, endY,
        reqCoordType: "WGS84GEO",
        resCoordType: "WGS84GEO",
        searchOption: 0
      })
    })
            .then(res => res.json())
            .then(data => {
              const result = data.features;
              const path = [];

              result.forEach(feature => {
                if (feature.geometry.type === "LineString") {
                  feature.geometry.coordinates.forEach(coord => {
                    path.push(new Tmapv2.LatLng(coord[1], coord[0]));
                  });
                }
              });

              new Tmapv2.Polyline({
                path: path,
                strokeColor: "#FF0000",
                strokeWeight: 4,
                map: map
              });

              map.setCenter(path[0]);

              const properties = result[0].properties;
              document.getElementById('fare').textContent = properties.taxiFare;
              const minutes = Math.round(properties.totalTime / 60);
              document.getElementById('time').textContent = `${minutes}ë¶„`;

              const startMarker = new Tmapv2.Marker({
                position: new Tmapv2.LatLng(startLat, startLon),
                map: map
              });

              const endMarker = new Tmapv2.Marker({
                position: new Tmapv2.LatLng(endLat, endLon),
                map: map
              });
            });
  }
</script>
<script>
  function toggleParticipants() {
    const list = document.getElementById('participantList');
    if (list.style.display === 'none') {
      list.style.display = 'block';
    } else {
      list.style.display = 'none';
    }
  }
  function handleEdit(postId) {
    if (confirm("ê¸°ì¡´ ê¸€ì„ ì‚­ì œí•˜ê³  ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      fetch(`/api/taxi-posts/${postId}/delete`, {
        method: "POST"
      })
              .then(response => {
                if (response.ok) {
                  alert("ì‚­ì œ ì™„ë£Œ. ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                  window.location.href = "/api/taxi-posts/new";

                } else {
                  alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              });
    }
  }
</script>


</body>
</html>
