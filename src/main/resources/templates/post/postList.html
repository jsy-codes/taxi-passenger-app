<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>ê²Œì‹œê¸€ ëª©ë¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=L5YgKBB01c4hpq2CIQupG4yaczLAmZBaaohHMfD0"></script>
    <script>
        async function joinPost(postId) {
            const StudentId = 1; // StudentID ê°’ ë¶ˆëŸ¬ì™€ì•¼í•¨

            const response = await fetch(`/api/taxi-posts/${postId}/join?StudentId=${StudentId}`, {
                method: 'POST'
            });

            const message = await response.text();
            alert(message);
            location.reload(); // ì°¸ì—¬ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        }
    </script>

</head>
<body>
<div class="container mt-4">
    <h1 class="mb-4">ì „ì²´ ê²Œì‹œê¸€</h1>

    <div class="mb-3">
        <strong>ì‚¬ìš©ì : </strong>
        <span th:text="${member.id}">ì•„ì´ë””</span><br>
        <strong>í•™ë²ˆ: </strong><span th:text="${member.studentId}">í•™ë²ˆ</span>
        <form th:action="@{/logout}" method="post">
            <button type="submit">ë¡œê·¸ì•„ì›ƒ</button>
        </form>

    </div>

    <!-- ê¸€ì“°ê¸° ë²„íŠ¼ -->
    <div class="mb-3">
        <a href="/api/taxi-posts/new" class="btn btn-primary">ê¸€ì“°ê¸°</a>
    </div>
    <div th:if="${member.participant != null}">
        <form th:action="@{/api/taxi-posts/cancel}" method="post"
              onsubmit="return confirm('ì°¸ì—¬ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
            <button type="submit" class="btn btn-warning btn-sm">ğŸš« ì°¸ì—¬ ì·¨ì†Œ</button>
        </form>
    </div>
    <br>

    <!-- ê²Œì‹œê¸€ í…Œì´ë¸” -->
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
        <tr>
            <th>ì‘ì„±ì</th>
            <th>ì¶œë°œì§€</th>
            <th>ë„ì°©ì§€</th>
            <th>ì¶œë°œ ì‹œê°„</th>
            <th>ìš”ê¸ˆ</th>
            <th>ìƒíƒœ</th>
            <th>ì°¸ì—¬ ì¸ì›</th>
            <th>ìƒì„¸</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="post : ${posts}"
            th:attr="data-lat=${post.departureLat}, data-lon=${post.departureLon}">
            <td th:text="${post.writer.id}">ì‘ì„±ìì•„ì´ë””</td>
            <td th:text="${post.departure}">ì¶œë°œ</td>
            <td th:text="${post.destination}">ë„ì°©</td>
            <td th:text="${post.departureTime}">ì‹œê°„</td>
            <td th:text="|${post.expectedFare}ì›|">ê¸ˆì•¡</td>
            <td th:text="${post.status}">ìƒíƒœ</td>
            <td th:text="${post.participants.size()} + ' / 4'">0 / 4</td>
            <td>
                <a th:href="@{/api/taxi-posts/{id}(id=${post.id})}" class="btn btn-sm btn-outline-primary">ìƒì„¸ ë³´ê¸°</a>
            </td>
        </tr>
        </tbody>
    </table>


    <script>

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        window.onload = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const myLat = position.coords.latitude;
                    const myLon = position.coords.longitude;

                    const rows = Array.from(document.querySelectorAll("tbody tr"));

                    rows.forEach(row => {
                        const lat = parseFloat(row.getAttribute("data-lat"));
                        const lon = parseFloat(row.getAttribute("data-lon"));
                        const dist = calculateDistance(myLat, myLon, lat, lon);
                        row.setAttribute("data-distance", dist);
                    });

                    rows.sort((a, b) =>
                        parseFloat(a.getAttribute("data-distance")) - parseFloat(b.getAttribute("data-distance"))
                    );

                    const tbody = document.querySelector("tbody");
                    tbody.innerHTML = "";
                    rows.forEach(row => tbody.appendChild(row));
                });
            } else {
                alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
            }
        };
    </script>

</div>
</body>
</html>
